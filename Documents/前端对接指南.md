# 前后端对接指南

**文档日期**: 2025年10月11日
**状态**: ✅ **对接完成，可以开始联调测试**

---

## 📋 概述

本文档提供前端对接后端API的完整指南，包括已完成的配置、API使用方式、测试方法和注意事项。

### 关键信息

- **后端服务地址**: `http://localhost:8000`
- **API基础路径**: `http://localhost:8000/api`
- **前端项目路径**: `/Users/showiix/Documents/EsportManager--frontend/esport-manager-frontend`
- **后端项目路径**: `/Users/showiix/Documents/EsportManager/backend`

---

## ✅ 已完成工作

### 1. 后端部署完成 ✅

- ✅ PostgreSQL数据库初始化完成
- ✅ Redis缓存服务运行正常
- ✅ 后端服务运行在端口 **8000**
- ✅ 9个新增API端点已实现并测试通过
- ✅ CORS配置支持前端访问

详见：`backend/部署测试报告.md`

### 2. 前端API服务层完成 ✅

#### 更新文件列表

1. **`src/api/client.ts`** - 更新端口配置
   - 开发环境端口从 `3001` 改为 `8000`
   - 匹配后端实际运行端口

2. **`src/types/index.ts`** - 添加新类型定义
   - `RegionalStandingItem` - 赛区积分榜项
   - `RegionalStandingsResponse` - 赛区积分榜响应
   - `AnnualRankingItem` - 年度排名项
   - `AnnualRankingsResponse` - 年度排名响应
   - `SeasonInfo` - 赛季信息
   - `HonorTeam` - 荣誉队伍
   - `RegionalHonor` - 赛区荣誉
   - `GlobalHonor` - 全球荣誉
   - `SeasonHonorsResponse` - 赛季荣誉响应
   - `CreateHonorRecordForm` - 创建荣誉记录表单
   - `UpdateRankingForm` - 更新排名表单

3. **`src/api/index.ts`** - 添加新API服务
   - `rankingApi` - 积分排名API
   - `honorHallApi` - 荣誉殿堂API

---

## 📚 API使用指南

### 1. 积分排名API（rankingApi）

#### 1.1 获取赛区常规赛积分榜

```typescript
import { rankingApi } from '@/api'

// 获取LPL春季赛积分榜
const standings = await rankingApi.getRegionalStandings('1', '1', 'spring')

console.log(standings.data.standings)
// [
//   {
//     teamId: '1',
//     teamName: 'JDG',
//     position: 1,
//     regularSeasonPoints: 45,
//     wins: 15,
//     losses: 3,
//     ...
//   }
// ]
```

**参数说明**:
- `regionId`: 赛区ID（'1'=LPL, '2'=LCK, '3'=LEC, '4'=LCS）
- `seasonId`: 赛季ID
- `type`: 赛事类型（'spring' | 'summer'）

#### 1.2 获取年度积分排名

```typescript
import { rankingApi } from '@/api'

// 获取2024赛季年度排名
const rankings = await rankingApi.getAnnualRankings('1')

console.log(rankings.data.annualRankings)
// [
//   {
//     teamId: '11',
//     teamName: 'T1',
//     position: 1,
//     totalPoints: 350,
//     springPoints: 54,
//     msiPoints: 100,
//     worldsPoints: 150,
//     achievements: ['春季赛冠军', 'MSI冠军'],
//     ...
//   }
// ]
```

#### 1.3 更新积分榜

```typescript
import { rankingApi } from '@/api'

// 更新赛区积分榜（比赛结束后调用）
await rankingApi.updateRegionalStandings({
  regionId: '1',
  seasonId: '1',
  type: 'spring'
})

// 更新年度排名（重要赛事结束后调用）
await rankingApi.updateAnnualRankings('1')

// 批量刷新所有排名
await rankingApi.refreshAllRankings('1')
```

---

### 2. 荣誉殿堂API（honorHallApi）

#### 2.1 获取可用赛季列表

```typescript
import { honorHallApi } from '@/api'

// 获取所有赛季
const seasons = await honorHallApi.getAvailableSeasons()

console.log(seasons.data)
// [
//   { id: '1', name: 'S1', year: 2024, status: 'active' }
// ]
```

#### 2.2 获取赛季荣誉数据

```typescript
import { honorHallApi } from '@/api'

// 获取S1赛季的所有荣誉
const honors = await honorHallApi.getSeasonHonors('1')

console.log(honors.data)
// {
//   seasonId: '1',
//   seasonYear: 2024,
//   regionalHonors: {
//     spring: [{ regionName: 'LPL', champion: {...}, ... }],
//     summer: [...]
//   },
//   globalHonors: {
//     msi: { champion: {...}, runnerUp: {...}, ... },
//     worlds: { champion: {...}, ... }
//   },
//   annualRankings: {
//     topThree: [...],
//     regionalTopThree: {...}
//   }
// }
```

#### 2.3 创建荣誉记录

```typescript
import { honorHallApi } from '@/api'

// 创建单条荣誉记录
await honorHallApi.createHonorRecord({
  seasonId: '1',
  competitionId: '1',
  teamId: '1',
  position: 1,
  points: 50,
  achievementDate: '2024-04-15'
})

// 批量创建荣誉记录
await honorHallApi.batchCreateHonorRecords([
  { seasonId: '1', competitionId: '1', teamId: '1', position: 1, points: 50 },
  { seasonId: '1', competitionId: '1', teamId: '2', position: 2, points: 35 },
  { seasonId: '1', competitionId: '1', teamId: '3', position: 3, points: 25 },
])
```

---

## 🧪 测试指南

### 前端测试步骤

#### 1. 确保后端服务运行

```bash
# 在backend目录
cd /Users/showiix/Documents/EsportManager/backend
npm run dev

# 看到以下输出表示成功：
# ✅ Database connected successfully
# ✅ Redis connected successfully
# 🚀 Server running on port 8000 in development mode
```

#### 2. 启动前端项目

```bash
# 在frontend目录
cd /Users/showiix/Documents/EsportManager--frontend/esport-manager-frontend
npm run dev

# 浏览器访问：http://localhost:5173
```

#### 3. 在浏览器控制台测试API

打开浏览器开发者工具，在Console中执行：

```javascript
// 测试1: 获取赛季列表
const seasons = await honorHallApi.getAvailableSeasons()
console.log('赛季列表:', seasons)

// 测试2: 获取年度排名
const rankings = await rankingApi.getAnnualRankings('1')
console.log('年度排名:', rankings)

// 测试3: 获取赛区积分榜
const standings = await rankingApi.getRegionalStandings('1', '1', 'spring')
console.log('LPL春季赛积分榜:', standings)

// 测试4: 获取赛季荣誉
const honors = await honorHallApi.getSeasonHonors('1')
console.log('赛季荣誉:', honors)
```

---

## 🎨 前端页面实现建议

### 1. 赛区积分榜页面

**文件建议**: `src/views/RankingsView.vue`

```vue
<template>
  <div class="rankings-page">
    <h1>赛区积分榜</h1>

    <!-- 筛选器 -->
    <div class="filters">
      <select v-model="selectedRegion">
        <option value="1">LPL</option>
        <option value="2">LCK</option>
        <option value="3">LEC</option>
        <option value="4">LCS</option>
      </select>

      <select v-model="selectedType">
        <option value="spring">春季赛</option>
        <option value="summer">夏季赛</option>
      </select>
    </div>

    <!-- 积分榜表格 -->
    <table v-if="standings">
      <thead>
        <tr>
          <th>排名</th>
          <th>战队</th>
          <th>场次</th>
          <th>胜/负</th>
          <th>胜率</th>
          <th>积分</th>
          <th>小场分差</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="team in standings.standings" :key="team.teamId">
          <td>{{ team.position }}</td>
          <td>{{ team.teamName }}</td>
          <td>{{ team.matchesPlayed }}</td>
          <td>{{ team.wins }}/{{ team.losses }}</td>
          <td>{{ team.winRate.toFixed(2) }}%</td>
          <td>{{ team.regularSeasonPoints }}</td>
          <td>{{ team.roundDifferential }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue'
import { rankingApi } from '@/api'

const selectedRegion = ref('1')
const selectedType = ref<'spring' | 'summer'>('spring')
const standings = ref(null)

// 加载积分榜数据
const loadStandings = async () => {
  try {
    const response = await rankingApi.getRegionalStandings(
      selectedRegion.value,
      '1', // seasonId
      selectedType.value
    )
    standings.value = response.data
  } catch (error) {
    console.error('加载积分榜失败:', error)
  }
}

// 监听筛选条件变化
watch([selectedRegion, selectedType], loadStandings, { immediate: true })
</script>
```

### 2. 年度积分排名页面

**文件建议**: `src/views/AnnualRankingsView.vue`

```vue
<template>
  <div class="annual-rankings-page">
    <h1>年度积分排名</h1>

    <table v-if="rankings">
      <thead>
        <tr>
          <th>排名</th>
          <th>战队</th>
          <th>赛区</th>
          <th>总积分</th>
          <th>春季赛</th>
          <th>夏季赛</th>
          <th>MSI</th>
          <th>世界赛</th>
          <th>成就</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="team in rankings.annualRankings" :key="team.teamId">
          <td>{{ team.position }}</td>
          <td>{{ team.teamName }}</td>
          <td>{{ team.regionName }}</td>
          <td><strong>{{ team.totalPoints }}</strong></td>
          <td>{{ team.springPoints }}</td>
          <td>{{ team.summerPoints }}</td>
          <td>{{ team.msiPoints }}</td>
          <td>{{ team.worldsPoints }}</td>
          <td>
            <span v-for="achievement in team.achievements" :key="achievement">
              {{ achievement }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { rankingApi } from '@/api'

const rankings = ref(null)

onMounted(async () => {
  try {
    const response = await rankingApi.getAnnualRankings('1')
    rankings.value = response.data
  } catch (error) {
    console.error('加载年度排名失败:', error)
  }
})
</script>
```

### 3. 荣誉殿堂页面

**文件建议**: `src/views/HonorHallView.vue`

```vue
<template>
  <div class="honor-hall-page">
    <h1>荣誉殿堂</h1>

    <!-- 赛季选择 -->
    <select v-model="selectedSeason">
      <option v-for="season in seasons" :key="season.id" :value="season.id">
        {{ season.name }} ({{ season.year }})
      </option>
    </select>

    <div v-if="honors">
      <!-- 赛区荣誉 -->
      <section class="regional-honors">
        <h2>赛区荣誉</h2>

        <h3>春季赛</h3>
        <div v-for="region in honors.regionalHonors.spring" :key="region.regionId">
          <h4>{{ region.regionName }}</h4>
          <p>冠军: {{ region.champion?.teamName }}</p>
          <p>亚军: {{ region.runnerUp?.teamName }}</p>
          <p>季军: {{ region.thirdPlace?.teamName }}</p>
        </div>

        <h3>夏季赛</h3>
        <div v-for="region in honors.regionalHonors.summer" :key="region.regionId">
          <h4>{{ region.regionName }}</h4>
          <p>冠军: {{ region.champion?.teamName }}</p>
          <p>亚军: {{ region.runnerUp?.teamName }}</p>
        </div>
      </section>

      <!-- 全球荣誉 -->
      <section class="global-honors">
        <h2>全球赛事荣誉</h2>

        <div class="msi">
          <h3>MSI</h3>
          <p>冠军: {{ honors.globalHonors.msi?.champion?.teamName }}</p>
          <p>亚军: {{ honors.globalHonors.msi?.runnerUp?.teamName }}</p>
        </div>

        <div class="worlds">
          <h3>世界赛</h3>
          <p>冠军: {{ honors.globalHonors.worlds?.champion?.teamName }}</p>
          <p>亚军: {{ honors.globalHonors.worlds?.runnerUp?.teamName }}</p>
        </div>
      </section>

      <!-- 年度排名 -->
      <section class="annual-top-three">
        <h2>年度排名前三</h2>
        <ol>
          <li v-for="team in honors.annualRankings?.topThree" :key="team.teamId">
            {{ team.teamName }} - {{ team.totalPoints }}分
          </li>
        </ol>
      </section>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from 'vue'
import { honorHallApi } from '@/api'

const seasons = ref([])
const selectedSeason = ref('1')
const honors = ref(null)

// 加载赛季列表
onMounted(async () => {
  try {
    const response = await honorHallApi.getAvailableSeasons()
    seasons.value = response.data
    if (seasons.value.length > 0) {
      selectedSeason.value = seasons.value[0].id
    }
  } catch (error) {
    console.error('加载赛季列表失败:', error)
  }
})

// 加载赛季荣誉
const loadHonors = async () => {
  try {
    const response = await honorHallApi.getSeasonHonors(selectedSeason.value)
    honors.value = response.data
  } catch (error) {
    console.error('加载荣誉数据失败:', error)
  }
}

watch(selectedSeason, loadHonors, { immediate: true })
</script>
```

---

## 🔍 常见问题

### 1. CORS跨域错误

**问题**: 前端请求被CORS策略阻止

**解决方案**:
- 确认后端`.env`文件中`CORS_ORIGIN`包含前端地址
- 当前配置：`CORS_ORIGIN=http://localhost:5173,http://localhost:8000`

### 2. 数据为空

**问题**: 积分榜和年度排名返回空数组

**原因**: 数据库中没有积分数据

**解决方案**:
1. 先完成一些比赛（使用比赛模拟功能）
2. 调用更新接口计算积分：
```typescript
// 更新赛区积分
await rankingApi.updateRegionalStandings({
  regionId: '1',
  seasonId: '1',
  type: 'spring'
})

// 更新年度排名
await rankingApi.updateAnnualRankings('1')
```

### 3. 连接超时

**问题**: API请求超时

**检查清单**:
- ✅ 后端服务是否运行（`npm run dev`）
- ✅ 端口是否正确（8000）
- ✅ PostgreSQL是否运行
- ✅ Redis是否运行

---

## 📊 数据流程图

```
前端用户操作
    ↓
调用API (rankingApi / honorHallApi)
    ↓
axios请求 → http://localhost:8000/api/...
    ↓
后端Controller接收请求
    ↓
Service层业务逻辑
    ↓
数据库查询（PostgreSQL）
    ↓
Redis缓存（可选）
    ↓
返回响应数据
    ↓
前端接收并展示
```

---

## 🎯 下一步工作建议

### 短期（本周）
1. 在前端实现积分榜页面
2. 在前端实现年度排名页面
3. 在前端实现荣誉殿堂页面
4. 完整的前后端联调测试
5. 添加比赛完成后自动更新积分的逻辑

### 中期（下周）
1. 优化页面UI/UX
2. 添加数据图表展示（使用echarts/chart.js）
3. 添加实时数据更新
4. 性能优化和缓存策略
5. 错误处理和用户提示

### 长期
1. 添加历史数据查看功能
2. 添加数据导出功能
3. 添加统计分析功能
4. 移动端适配
5. 国际化支持

---

## 📝 积分计算规则参考

### 常规赛积分
- 2:0 获胜 → 3分
- 2:1 获胜 → 2分
- 1:2 失败 → 1分
- 0:2 失败 → 0分

### 季后赛积分
- 冠军 → 50分
- 亚军 → 35分
- 半决赛（3-4名） → 25分
- 四分之一决赛（5-8名） → 15分

### MSI积分
- 冠军 → 100分
- 亚军 → 80分
- 半决赛 → 60分
- 小组赛 → 20分

### 世界赛积分
- 冠军 → 150分
- 亚军 → 120分
- 半决赛 → 90分
- 四分之一决赛 → 60分
- 小组赛 → 30分

### 洲际赛
**重要**: 洲际赛积分不计入年度总积分，仅用于荣誉展示

---

## 🌐 API端点速查表

### 积分排名API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/rankings/regional` | 获取赛区常规赛积分榜 |
| GET | `/api/rankings/annual` | 获取年度积分排名 |
| POST | `/api/rankings/regional/update` | 更新赛区积分榜 |
| POST | `/api/rankings/annual/update` | 更新年度积分排名 |
| POST | `/api/rankings/refresh` | 批量刷新所有排名 |

### 荣誉殿堂API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/honor-hall/seasons` | 获取可用赛季列表 |
| GET | `/api/honor-hall/seasons/:seasonId/honors` | 获取赛季荣誉数据 |
| POST | `/api/honor-hall/records` | 创建单条荣誉记录 |
| POST | `/api/honor-hall/records/batch` | 批量创建荣誉记录 |

---

## 📞 技术支持

### 相关文档
- **后端部署报告**: `backend/部署测试报告.md`
- **后端接口文档**: `frontend/后端接口文档.md`
- **前后端对接计划**: `backend/前后端对接工作计划.md`
- **完成报告**: `backend/前后端对接工作完成报告.md`

### 遇到问题？

1. **检查后端日志**: 查看后端控制台输出
2. **检查浏览器控制台**: 查看网络请求和错误信息
3. **验证数据**: 使用curl或Postman直接测试API
4. **查看文档**: 参考上述相关文档

---

**文档生成时间**: 2025年10月11日 19:00
**状态**: ✅ 准备就绪，可以开始前端开发和联调
**下一步**: 实现前端页面并进行完整的集成测试

---

*祝开发顺利！有任何问题随时沟通。*
