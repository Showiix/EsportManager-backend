# 电竞赛事模拟系统 - 前后端对接工作计划

## 📋 项目概述

本文档详细说明前后端对接的完整工作计划，包括API实现优先级、数据结构对齐、测试方案和部署策略。

**编制时间**: 2025年10月11日
**项目状态**: 前端开发完成，后端核心功能已实现，准备开始对接
**预计工期**: 3-5个工作日

---

## 🎯 对接目标

### 核心目标
1. ✅ 实现前端所需的全部API接口
2. ✅ 确保数据格式完全兼容
3. ✅ 建立稳定的前后端通信机制
4. ✅ 完成端到端功能测试
5. ✅ 优化性能和用户体验

### 质量标准
- API响应时间 < 500ms
- 接口成功率 > 99%
- 数据一致性 100%
- 错误处理覆盖率 100%

---

## 📊 当前状态评估

### 后端已完成（第二阶段）
- ✅ 数据库设计与初始化
- ✅ 核心业务服务（Team, Competition, Match）
- ✅ 赛程生成引擎（CompetitionEngine）
- ✅ 积分计算引擎（ScoringEngine）
- ✅ 基础API接口框架
- ✅ 单元测试（45个测试用例全部通过）

### 前端已完成（第七阶段）
- ✅ 战队管理界面
- ✅ 赛区管理界面
- ✅ 赛程管理界面
- ✅ 积分排名系统
- ✅ 荣誉殿堂系统
- ✅ 系统设置模块
- ✅ 完整的API接口文档

### 待对接模块
- ❌ 积分排名API（核心）
- ❌ 荣誉殿堂API（核心）
- ❌ 赛程模拟功能完善
- ❌ 实时数据更新机制
- ❌ CORS配置
- ❌ 错误处理统一

---

## 🔧 技术栈对齐

### 前端技术栈
- **框架**: Vue 3.4+ + TypeScript 5.0+
- **UI库**: Element Plus 2.4+
- **状态管理**: Pinia 2.1+
- **HTTP客户端**: Axios
- **开发服务器**: Vite (端口: 5173)

### 后端技术栈
- **运行时**: Node.js 18+ + TypeScript 5.0+
- **框架**: Express.js 4.x
- **数据库**: PostgreSQL 14+
- **缓存**: Redis 7+
- **开发服务器**: 端口 3000 (建议改为 8080)

### 通信协议
- **协议**: HTTP/HTTPS + JSON
- **CORS**: 允许 http://localhost:5173
- **认证**: 暂无（后续可添加JWT）
- **实时通信**: WebSocket（可选，后期添加）

---

## 📝 API对接清单

### 第一优先级（核心功能）

#### 1. 战队管理API ✅ (已实现)
```typescript
GET    /api/teams                    // 获取战队列表
GET    /api/teams/:id                // 获取战队详情
POST   /api/teams                    // 创建战队
PUT    /api/teams/:id                // 更新战队
DELETE /api/teams/:id                // 删除战队
GET    /api/teams/:id/statistics     // 获取战队统计
```

#### 2. 赛区管理API ✅ (已实现)
```typescript
GET    /api/regions                  // 获取赛区列表
GET    /api/regions/:id              // 获取赛区详情
GET    /api/regions/:id/teams        // 获取赛区战队
```

#### 3. 赛季管理API ✅ (已实现)
```typescript
GET    /api/seasons                  // 获取赛季列表
GET    /api/seasons/:id              // 获取赛季详情
POST   /api/seasons                  // 创建赛季
GET    /api/seasons/:id/competitions // 获取赛季赛事
```

#### 4. 赛事管理API ⚠️ (部分实现)
```typescript
GET    /api/competitions             // 获取赛事列表
GET    /api/competitions/:id         // 获取赛事详情
POST   /api/competitions             // 创建赛事
POST   /api/competitions/:id/generate-matches // 生成对阵
GET    /api/competitions/:id/standings        // 获取积分榜 ❌ 待实现
```

#### 5. 比赛管理API ⚠️ (部分实现)
```typescript
GET    /api/matches                  // 获取比赛列表
GET    /api/matches/:id              // 获取比赛详情
POST   /api/matches/:id/simulate     // 模拟比赛
PUT    /api/matches/:id/result       // 更新比赛结果
```

### 第二优先级（积分排名）❌ 待实现

#### 6. 积分排名API
```typescript
GET    /api/rankings/regional        // 获取赛区常规赛积分榜
  ?regionId=1&seasonId=1&type=spring

GET    /api/rankings/annual          // 获取年度积分排名
  ?seasonId=1

POST   /api/rankings/regional/update // 更新赛区积分榜
POST   /api/rankings/annual/update   // 更新年度积分排名
POST   /api/rankings/refresh         // 刷新所有排名
```

### 第三优先级（荣誉殿堂）❌ 待实现

#### 7. 荣誉殿堂API
```typescript
GET    /api/honor-hall/seasons                    // 获取可用赛季
GET    /api/honor-hall/seasons/:id/honors         // 获取赛季荣誉数据
GET    /api/honor-hall/regional-honors            // 获取赛区荣誉
GET    /api/honor-hall/global-honors              // 获取全球赛事荣誉
GET    /api/honor-hall/annual-rankings            // 获取年度积分排名
```

---

## 🗂️ 数据结构对齐

### 1. 统一响应格式

**成功响应:**
```typescript
interface ApiResponse<T> {
  success: true
  data: T
  message: string
}
```

**错误响应:**
```typescript
interface ApiErrorResponse {
  success: false
  data: null
  message: string
  errors?: string[]
}
```

**分页响应:**
```typescript
interface PaginatedResponse<T> {
  data: T[]
  total: number
  page: number
  limit: number
  totalPages: number
}
```

### 2. 核心数据结构

#### Team (战队)
```typescript
interface Team {
  id: string
  name: string
  regionId: string
  strength: number        // 0-100
  createdAt?: string
  statistics?: {
    totalMatches: number
    wins: number
    losses: number
    winRate: number       // 0-1
    totalPoints: number
    seasonPoints: number
    intercontinentalPoints: number
  }
}
```

#### Competition (赛事)
```typescript
interface Competition {
  id: string
  name: string
  type: 'spring' | 'summer' | 'msi' | 'worlds' | 'intercontinental'
  format: 'regular_season' | 'playoffs' | 'double_elimination' | 'swiss'
  seasonId: string
  status: 'planned' | 'ongoing' | 'completed'
  teams: Team[]
  matches?: Match[]
  stages?: CompetitionStage[]
}
```

#### Match (比赛)
```typescript
interface Match {
  id: string
  competitionId: string
  homeTeamId: string
  awayTeamId: string
  round: number
  stage: string
  status: 'scheduled' | 'ongoing' | 'completed'
  regionId: string
  result?: {
    homeScore: number     // 0-2
    awayScore: number     // 0-2
    homePoints: number    // 0-3
    awayPoints: number    // 0-3
    winner?: string
  }
  scheduledAt?: string
  playedAt?: string
}
```

#### RegionalStanding (赛区积分榜)
```typescript
interface RegularSeasonStanding {
  teamId: string
  teamName: string
  regionId: string
  regionName: string
  matchesPlayed: number
  wins: number
  losses: number
  winRate: number          // 百分比，如 83.33
  regularSeasonPoints: number
  roundDifferential: number // 小场分差
  position: number         // 排名
  lastUpdated: string
}
```

#### AnnualRanking (年度积分排名)
```typescript
interface AnnualTeamRanking {
  teamId: string
  teamName: string
  regionId: string
  regionName: string
  totalPoints: number      // 总积分（不包含洲际赛）
  springPoints: number
  summerPoints: number
  playoffPoints: number
  msiPoints: number
  worldsPoints: number
  intercontinentalPoints: number // 仅展示，不计入总分
  achievements: string[]
  position: number
  seasonId: string
}
```

---

## 🔄 积分计算规则

### 常规赛积分
| 比赛结果 | 积分 |
|---------|------|
| 2:0 获胜 | 3分 |
| 2:1 获胜 | 2分 |
| 1:2 失败 | 1分 |
| 0:2 失败 | 0分 |

### 季后赛积分
| 名次 | 积分 |
|------|------|
| 冠军 | 50分 |
| 亚军 | 35分 |
| 半决赛 | 25分 |
| 四分之一 | 15分 |

### MSI积分
| 名次 | 积分 |
|------|------|
| 冠军 | 100分 |
| 亚军 | 80分 |
| 半决赛 | 60分 |
| 小组赛 | 20分 |

### 世界赛积分
| 名次 | 积分 |
|------|------|
| 冠军 | 150分 |
| 亚军 | 120分 |
| 半决赛 | 90分 |
| 四分之一 | 60分 |
| 小组赛 | 30分 |

### 洲际赛积分
⚠️ **重要**: 洲际赛积分**不计入年度总积分**，仅作为荣誉展示

---

## 🚀 开发实施计划

### 阶段一：环境配置与基础对接（0.5天）

**任务清单:**
- [x] 配置CORS允许前端访问
- [x] 统一API响应格式
- [x] 修改后端端口为8080
- [x] 配置环境变量
- [x] 测试基础连通性

**验收标准:**
- 前端可以成功调用后端API
- 响应格式符合约定
- 无CORS错误

### 阶段二：核心API完善（1天）

**任务清单:**
- [ ] 完善战队管理API
- [ ] 完善赛事管理API
- [ ] 完善比赛管理API
- [ ] 添加积分榜查询接口
- [ ] 测试核心功能

**验收标准:**
- 战队列表、详情正常显示
- 赛事创建、查询正常
- 比赛模拟功能正常

### 阶段三：积分排名系统对接（1.5天）

**任务清单:**
- [ ] 创建RankingService
- [ ] 实现赛区积分榜计算
- [ ] 实现年度积分排名计算
- [ ] 创建排名API接口
- [ ] 集成到比赛结果更新流程
- [ ] 前后端联调测试

**验收标准:**
- 赛区积分榜正确显示
- 年度积分排名正确计算
- 比赛结束后积分自动更新

### 阶段四：荣誉殿堂系统对接（1天）

**任务清单:**
- [ ] 创建HonorHallService
- [ ] 实现赛季荣誉数据计算
- [ ] 实现荣誉记录存储
- [ ] 创建荣誉殿堂API
- [ ] 前后端联调测试

**验收标准:**
- 荣誉殿堂正确显示各赛事冠亚季军
- 年度积分前三正确计算
- 洲际赛荣誉正确标识

### 阶段五：功能优化与Bug修复（1天）

**任务清单:**
- [ ] 修复前端UI Bug（赛程管理五场比赛显示）
- [ ] 优化API响应速度
- [ ] 添加数据缓存机制
- [ ] 完善错误处理
- [ ] 端到端测试

**验收标准:**
- 所有已知Bug修复完成
- API响应时间 < 500ms
- 错误提示友好明确

---

## 🧪 测试方案

### 1. 单元测试
- 积分计算逻辑测试
- 排名算法测试
- 数据验证测试

### 2. 集成测试
- API接口测试
- 数据库操作测试
- 缓存机制测试

### 3. 端到端测试
- 完整赛季流程测试
- 比赛模拟测试
- 积分更新测试

### 4. 性能测试
- 并发请求测试
- 大数据量查询测试
- 缓存命中率测试

---

## 📂 文件结构规划

### 后端新增文件
```
backend/src/
├── services/
│   ├── RankingService.ts      # 积分排名服务 ❌ 待创建
│   └── HonorHallService.ts    # 荣誉殿堂服务 ❌ 待创建
├── repositories/
│   ├── RankingRepository.ts   # 排名数据访问 ❌ 待创建
│   └── HonorRepository.ts     # 荣誉数据访问 ❌ 待创建
├── controllers/
│   ├── RankingController.ts   # 排名控制器 ❌ 待创建
│   └── HonorHallController.ts # 荣誉控制器 ❌ 待创建
├── routes/
│   ├── rankings.ts            # 排名路由 ❌ 待创建
│   └── honorHall.ts           # 荣誉路由 ❌ 待创建
└── middlewares/
    ├── cors.ts                # CORS配置 ❌ 待创建
    └── responseFormatter.ts   # 响应格式化 ❌ 待创建
```

### 数据库新增表
```sql
-- 赛区积分榜表
CREATE TABLE regional_standings (
  id VARCHAR(50) PRIMARY KEY,
  team_id VARCHAR(50) NOT NULL,
  region_id VARCHAR(50) NOT NULL,
  season_id VARCHAR(50) NOT NULL,
  competition_type ENUM('spring', 'summer'),
  matches_played INT DEFAULT 0,
  wins INT DEFAULT 0,
  losses INT DEFAULT 0,
  win_rate DECIMAL(5,2),
  regular_season_points INT DEFAULT 0,
  round_differential INT DEFAULT 0,
  position INT,
  last_updated TIMESTAMP,

  INDEX idx_region_season (region_id, season_id, competition_type)
);

-- 年度积分排名表
CREATE TABLE annual_rankings (
  id VARCHAR(50) PRIMARY KEY,
  team_id VARCHAR(50) NOT NULL,
  season_id VARCHAR(50) NOT NULL,
  total_points INT DEFAULT 0,
  spring_points INT DEFAULT 0,
  summer_points INT DEFAULT 0,
  playoff_points INT DEFAULT 0,
  msi_points INT DEFAULT 0,
  worlds_points INT DEFAULT 0,
  intercontinental_points INT DEFAULT 0,
  achievements JSON,
  position INT,
  last_updated TIMESTAMP,

  UNIQUE KEY uk_team_season (team_id, season_id)
);

-- 荣誉记录表
CREATE TABLE honor_records (
  id VARCHAR(50) PRIMARY KEY,
  season_id VARCHAR(50) NOT NULL,
  competition_id VARCHAR(50) NOT NULL,
  team_id VARCHAR(50) NOT NULL,
  position INT NOT NULL,  -- 1:冠军, 2:亚军, 3:季军
  points INT DEFAULT 0,
  achievement_date TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 🔍 关键技术点

### 1. CORS配置
```typescript
// src/middlewares/cors.ts
import cors from 'cors'

export const corsOptions = {
  origin: process.env.NODE_ENV === 'production'
    ? 'https://your-frontend-domain.com'
    : 'http://localhost:5173',
  credentials: true,
  optionsSuccessStatus: 200
}
```

### 2. 响应格式化中间件
```typescript
// src/middlewares/responseFormatter.ts
export const formatResponse = (data: any, message = '操作成功') => {
  return {
    success: true,
    data,
    message
  }
}

export const formatError = (message: string, errors?: string[]) => {
  return {
    success: false,
    data: null,
    message,
    errors
  }
}
```

### 3. 积分计算核心逻辑
```typescript
// src/services/RankingService.ts
export class RankingService {
  // 计算常规赛积分
  calculateRegularPoints(homeScore: number, awayScore: number): {
    homePoints: number
    awayPoints: number
  } {
    if (homeScore === 2 && awayScore === 0) return { homePoints: 3, awayPoints: 0 }
    if (homeScore === 2 && awayScore === 1) return { homePoints: 2, awayPoints: 1 }
    if (homeScore === 1 && awayScore === 2) return { homePoints: 1, awayPoints: 2 }
    if (homeScore === 0 && awayScore === 2) return { homePoints: 0, awayPoints: 3 }
    return { homePoints: 0, awayPoints: 0 }
  }

  // 计算季后赛积分
  calculatePlayoffPoints(position: number): number {
    const pointsMap = { 1: 50, 2: 35, 3: 25, 4: 25, 5: 15, 6: 15, 7: 15, 8: 15 }
    return pointsMap[position] || 0
  }

  // 更新赛区积分榜
  async updateRegionalStandings(regionId: string, seasonId: string, type: 'spring' | 'summer') {
    // 实现逻辑
  }
}
```

---

## 📊 进度追踪

### 开发进度看板

| 模块 | 优先级 | 状态 | 负责人 | 预计完成 | 实际完成 |
|------|--------|------|--------|----------|----------|
| CORS配置 | P0 | ⏳ 进行中 | - | Day 1 | - |
| 响应格式统一 | P0 | ⏳ 进行中 | - | Day 1 | - |
| 战队API完善 | P0 | 📋 待开始 | - | Day 1 | - |
| 赛事API完善 | P0 | 📋 待开始 | - | Day 2 | - |
| 积分排名API | P1 | 📋 待开始 | - | Day 3 | - |
| 荣誉殿堂API | P2 | 📋 待开始 | - | Day 4 | - |
| Bug修复 | P1 | 📋 待开始 | - | Day 5 | - |
| 端到端测试 | P1 | 📋 待开始 | - | Day 5 | - |

### 里程碑

- **Day 1**: ✅ 基础对接完成，前端可访问后端
- **Day 2**: ✅ 核心功能对接完成
- **Day 3**: ✅ 积分排名系统上线
- **Day 4**: ✅ 荣誉殿堂系统上线
- **Day 5**: ✅ 全部功能测试通过，系统可上线

---

## 🚨 风险预警

### 技术风险
1. **数据库性能** - 大量数据查询可能影响响应速度
   - **缓解措施**: 使用Redis缓存，优化SQL查询

2. **并发冲突** - 多个比赛同时更新积分可能冲突
   - **缓解措施**: 使用数据库事务，添加乐观锁

3. **前后端数据不一致** - Mock数据与实际数据结构差异
   - **缓解措施**: 严格按照接口文档开发，充分测试

### 进度风险
1. **需求变更** - 甲方可能提出新需求
   - **缓解措施**: 控制变更范围，优先完成核心功能

2. **技术难点** - 复杂积分计算逻辑可能耗时
   - **缓解措施**: 提前设计算法，编写单元测试

---

## 📞 协作机制

### 沟通方式
- **日常沟通**: 项目群 / 邮件
- **技术讨论**: 代码Review / 技术文档
- **问题反馈**: Issue跟踪系统

### 代码规范
- **提交规范**: feat/fix/docs/refactor
- **分支策略**: feature/* → dev → main
- **代码审查**: 所有代码需经过Review

### 文档维护
- **API文档**: 保持与代码同步更新
- **数据库文档**: 记录所有表结构变更
- **接口变更日志**: 记录破坏性变更

---

## ✅ 验收标准

### 功能验收
- [ ] 所有前端页面可正常访问后端数据
- [ ] 战队、赛事、比赛CRUD功能正常
- [ ] 比赛模拟后积分正确更新
- [ ] 赛区积分榜正确显示
- [ ] 年度积分排名正确计算
- [ ] 荣誉殿堂数据正确展示
- [ ] 洲际赛积分正确标识（不计入总分）

### 性能验收
- [ ] API平均响应时间 < 500ms
- [ ] 并发100用户系统稳定
- [ ] 数据查询无明显卡顿

### 质量验收
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] 无高危Bug
- [ ] 代码通过ESLint检查

---

## 📚 参考文档

1. **前端接口文档**: `/前端过来/后端接口文档.md`
2. **游戏逻辑文档**: `/前端过来/游戏逻辑.md`
3. **后端第二阶段报告**: `/backend/第二阶段工作报告.md`
4. **前端第六阶段报告**: `/前端过来/第六阶段工作报告.md` (积分排名)
5. **前端第五阶段报告**: `/前端过来/第五阶段工作报告.md` (荣誉殿堂)

---

## 🎯 下一步行动

### 立即开始的任务
1. ✅ 创建本工作计划文档
2. ⏳ 配置CORS中间件
3. ⏳ 统一响应格式
4. ⏳ 创建RankingService和HonorHallService
5. ⏳ 实现积分计算核心逻辑

### 本周目标
- 完成阶段一、二、三
- 积分排名系统全面上线
- 前端可正常查看积分榜和排名

---

**文档版本**: v1.0
**最后更新**: 2025年10月11日
**状态**: 📋 工作计划已制定，准备开始实施
