# æ•°æ®åº“è¡¨ç»“æ„é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åœ¨å®ç°å¤å­£èµ›ç”ŸæˆåŠŸèƒ½çš„å‰åç«¯è”è°ƒè¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†æ•°æ®åº“è¡¨ç»“æ„ä¸ä»£ç é€»è¾‘ä¸åŒ¹é…çš„é—®é¢˜ã€‚

## ğŸ› å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼š`playoff_brackets` è¡¨ç¼ºå°‘ `season_id` å­—æ®µ

**é”™è¯¯ä¿¡æ¯**:
```
ERROR: column "season_id" does not exist in table "playoff_brackets"
HINT: Perhaps you meant to reference the column "playoff_brackets.region_id"
```

**åŸå› **: 
- `playoff_brackets` è¡¨åªæœ‰ `competition_id` å’Œ `region_id`
- ä»£ç ä¸­å°è¯•ä½¿ç”¨ `season_id` ç›´æ¥æŸ¥è¯¢

**å·²ä¿®å¤**: âœ…
```sql
-- ä¿®å¤å‰
SELECT status FROM playoff_brackets WHERE season_id = $1

-- ä¿®å¤å  
SELECT pb.status FROM playoff_brackets pb
INNER JOIN competitions c ON pb.competition_id = c.id
WHERE c.season_id = $1
```

### é—®é¢˜2ï¼š`competitions` è¡¨ç¼ºå°‘ `region_id` å­—æ®µ

**é”™è¯¯ä¿¡æ¯**:
```
error: "column \"region_id\" does not exist"
```

**å½±å“ä»£ç **:
```typescript
// SeasonService.ts ç¬¬135è¡Œ
const competitionData = {
  name: `${region.name} 2025 å¤å­£èµ›`,
  type: CompetitionType.SUMMER,
  seasonId,
  regionId: region.id,  // âŒ competitionsè¡¨å¯èƒ½æ²¡æœ‰è¿™ä¸ªå­—æ®µ
  ...
}
```

**éœ€è¦ä¿®å¤**: âš ï¸ å¾…å¤„ç†

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ·»åŠ  `region_id` å­—æ®µåˆ° `competitions` è¡¨ï¼ˆæ¨èï¼‰

**ç†ç”±**:
- ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼ˆæ¯ä¸ªèµ›äº‹å±äºä¸€ä¸ªèµ›åŒºï¼‰
- ä»£ç æ— éœ€å¤§æ”¹åŠ¨
- æŸ¥è¯¢æ›´é«˜æ•ˆ

**å®æ–½æ­¥éª¤**:

1. **å¤‡ä»½æ•°æ®åº“**:
```bash
pg_dump -U postgres esport_manager > backup_$(date +%Y%m%d).sql
```

2. **æ·»åŠ å­—æ®µ**:
```sql
-- æ·»åŠ  region_id å­—æ®µ
ALTER TABLE competitions 
ADD COLUMN region_id INTEGER REFERENCES regions(id);

-- ä¸ºç°æœ‰æ•°æ®è®¾ç½®é»˜è®¤å€¼ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
UPDATE competitions SET region_id = 1 WHERE region_id IS NULL;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_competitions_region ON competitions(region_id);
```

3. **éªŒè¯**:
```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
\d competitions

-- æ£€æŸ¥æ•°æ®
SELECT id, name, type, season_id, region_id FROM competitions LIMIT 5;
```

### æ–¹æ¡ˆBï¼šä¿®æ”¹ä»£ç é€»è¾‘ï¼ˆä¸æ¨èï¼‰

é€šè¿‡ `competition_teams` è¡¨å…³è”æ¥æ¨æ–­èµ›åŒºï¼Œä½†è¿™ä¼šå¢åŠ ä»£ç å¤æ‚åº¦ã€‚

## ğŸ“ ä¿®å¤è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `/Users/showiix/Documents/EsportManager/backend/fix-competitions-table.sql`:

```sql
-- ===============================================
-- ä¿®å¤ competitions è¡¨ç»“æ„
-- ===============================================
-- æ—¥æœŸ: 2025-10-12
-- ç›®çš„: æ·»åŠ  region_id å­—æ®µä»¥æ”¯æŒå¤šèµ›åŒºèµ›äº‹ç®¡ç†
-- ===============================================

-- 1. æ·»åŠ  region_id å­—æ®µ
ALTER TABLE competitions 
ADD COLUMN IF NOT EXISTS region_id INTEGER;

-- 2. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE competitions 
ADD CONSTRAINT fk_competitions_region 
FOREIGN KEY (region_id) REFERENCES regions(id) 
ON DELETE SET NULL;

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_competitions_region 
ON competitions(region_id);

-- 4. ä¸ºç°æœ‰çš„æ˜¥å­£èµ›æ•°æ®è®¾ç½® region_idï¼ˆæ ¹æ®competition_teamsæ¨æ–­ï¼‰
WITH competition_regions AS (
  SELECT 
    c.id as competition_id,
    t.region_id
  FROM competitions c
  INNER JOIN competition_teams ct ON c.id = ct.competition_id
  INNER JOIN teams t ON ct.team_id = t.id
  WHERE c.region_id IS NULL
  GROUP BY c.id, t.region_id
)
UPDATE competitions c
SET region_id = cr.region_id
FROM competition_regions cr
WHERE c.id = cr.competition_id;

-- 5. éªŒè¯ä¿®å¤ç»“æœ
SELECT 
  c.id, 
  c.name, 
  c.type, 
  c.season_id, 
  c.region_id,
  r.name as region_name
FROM competitions c
LEFT JOIN regions r ON c.region_id = r.id
ORDER BY c.id DESC
LIMIT 10;

-- 6. ç»Ÿè®¡ä¿¡æ¯
SELECT 
  'æ€»èµ›äº‹æ•°' as metric, 
  COUNT(*) as count 
FROM competitions
UNION ALL
SELECT 
  'å·²è®¾ç½®èµ›åŒºçš„èµ›äº‹', 
  COUNT(*) 
FROM competitions 
WHERE region_id IS NOT NULL
UNION ALL
SELECT 
  'æœªè®¾ç½®èµ›åŒºçš„èµ›äº‹', 
  COUNT(*) 
FROM competitions 
WHERE region_id IS NULL;
```

## ğŸš€ æ‰§è¡Œä¿®å¤

### æ–¹æ³•1ï¼šä½¿ç”¨SQLæ–‡ä»¶

```bash
# è¿›å…¥åç«¯ç›®å½•
cd /Users/showiix/Documents/EsportManager/backend 

# æ‰§è¡Œä¿®å¤è„šæœ¬
psql -U postgres -d esport_manager -f fix-competitions-table.sql
```

### æ–¹æ³•2ï¼šç›´æ¥æ‰§è¡ŒSQL

```bash
psql -U postgres -d esport_manager << 'EOF'
ALTER TABLE competitions ADD COLUMN IF NOT EXISTS region_id INTEGER;
ALTER TABLE competitions ADD CONSTRAINT fk_competitions_region 
  FOREIGN KEY (region_id) REFERENCES regions(id) ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_competitions_region ON competitions(region_id);
EOF
```

## âœ… éªŒè¯ä¿®å¤

æ‰§è¡Œä¿®å¤åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# 1. æ£€æŸ¥è¡¨ç»“æ„
psql -U postgres -d esport_manager -c "\d competitions"

# 2. æµ‹è¯•API
curl -X POST http://localhost:8000/api/seasons/1/proceed-to-summer \
  -H "Content-Type: application/json" | jq '.'

# 3. æ£€æŸ¥ç”Ÿæˆçš„å¤å­£èµ›
curl -s "http://localhost:8000/api/competitions?seasonId=1&type=summer" | jq '.data'
```

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤åçš„APIå“åº”åº”è¯¥æ˜¯ï¼š

```json
{
  "success": true,
  "data": {
    "message": "æˆåŠŸæ¨è¿›åˆ°å¤å­£èµ›",
    "summerCompetitions": [/* 4ä¸ªèµ›åŒºçš„å¤å­£èµ› */],
    "totalMatchesGenerated": 720,
    "regionResults": [
      {
        "regionId": 1,
        "regionName": "ä¸­å›½å¤§é™†èŒä¸šè”èµ›",
        "competitionId": "uuid",
        "matchesGenerated": 180,
        "success": true
      }
      // ... å…¶ä»–3ä¸ªèµ›åŒº
    ],
    "summary": {
      "totalRegions": 4,
      "successfulRegions": 4,
      "failedRegions": 0
    }
  }
}
```

## ğŸ¯ åç»­å»ºè®®

1. **æ•°æ®åº“æ–‡æ¡£åŒ–**
   - ç»´æŠ¤å®Œæ•´çš„è¡¨ç»“æ„æ–‡æ¡£
   - è®°å½•å­—æ®µç”¨é€”å’Œçº¦æŸ

2. **Migrationç®¡ç†**
   - ä½¿ç”¨TypeORMæˆ–ç±»ä¼¼å·¥å…·ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬
   - é¿å…æ‰‹åŠ¨ä¿®æ”¹è¡¨ç»“æ„

3. **ä»£ç ä¸æ•°æ®åº“åŒæ­¥**
   - å®šæœŸæ£€æŸ¥ä»£ç å‡è®¾ä¸å®é™…è¡¨ç»“æ„çš„ä¸€è‡´æ€§
   - æ·»åŠ é›†æˆæµ‹è¯•éªŒè¯æ•°æ®åº“æ“ä½œ

## ğŸ“š ç›¸å…³æ–‡ä»¶

- [SeasonService.ts](/Users/showiix/Documents/EsportManager/backend/src/services/SeasonService.ts)
- [create-playoff-tables.sql](/Users/showiix/Documents/EsportManager/backend/src/scripts/create-playoff-tables.sql)
- [create-msi-tables.sql](/Users/showiix/Documents/EsportManager/backend/src/scripts/create-msi-tables.sql)

---

**æ›´æ–°æ—¶é—´**: 2025-10-12  
**çŠ¶æ€**: ğŸ”„ å¾…ä¿®å¤æ•°æ®åº“è¡¨ç»“æ„
